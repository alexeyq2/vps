# VPS для дома

- Веб-панель 3X-UI для X-Ray
- Файлообменник c веб-мордой
- SSL сертификат для VLESS-Reality (Let's Encrypt)
- Автообновление geo.dat файлов для маршрутизации X-Ray
- Свой сайт на nginx, в логах нет IP-адресов

## Установка на чистую Ubuntu 24.04 LTS
 
Установить git, docker, скачать код проекта:

`curl -sL https://raw.githubusercontent.com/alexeyq2/vps/refs/heads/master/install.sh | bash`

## Настройка
1. Создайте файл  `.env` из шаблона

    `cp .env-default .env` 

2. отредактируйте `.env`, переменные:
  - `VPS_DOMAIN` - свой домен
  - `VPS_EMAIL`  - свой email (необязательно, для Let's Encrypt)
  - `ACME_SERVER` - тестовый или реальный сервер Let's Encrypt
  - `SUBSCRIPTION_URL` - уникальный путь (секретный) для подписок (subscription) VPN-клиентов. Поменяйте на что-нибудь свое, чтобы не палиться.

3. Создайте папку `srv` — тут хранятся конфиги VPN, сертификат и содержимое веб-сайта.

   `cp -r srv-default/ srv/`

### Важные папки и файлы

    srv - файлы конфигурации, база данных, файлообменник.
        - сохраняйте эту папку при обновлении или переустановке
    srv-default - скопируйте в "srv" и начинайте с неё
    _work - рабочие файлы. можно удалять
    .env - здесь вы настраиваете VPS под свой домен

### Запуск, остановка, логи

* `./up.sh`   # создать/запустить контейнеры
* `./stop.sh` # остановить контейнеры
* `./down.sh` # удалить контейнеры перед апгрейдом
* `./log.sh`  # [-f] [container-name - см. compose.yaml]

### Проверить, что certbot получил сертификат:

 `./log.sh -f certbot | grep received`

в `./log.sh -f certbot` должно быть что-то вроде:

```
certbot-1      | Successfully received certificate.
certbot-1      | Certificate is saved at: /etc/letsencrypt/live/VPS_DOMAIN/fullchain.pem
certbot-1      | Key is saved at:         /etc/letsencrypt/live/VPS_DOMAIN/privkey.pem
certbot-1      | This certificate expires on YYYY-MM-SS.
certbot-1      | These files will be updated when the certificate renews.
certbot-1      | NEXT STEPS:
```

## Чтобы заработал сайт, нужно сначала настроить 3X-UI

### Настройка панели 3X-UI

`http://VPS_IP_ADDRESS:2053` admin:admin

1. сменить порт с 2053 на что-то побольше типа 52050 (важно)
2. сменить URI path на рандом вроде /vps52050 (важно)
3. включить HTTPS - указать сертификат и ключ к нему.  `./print-my-opts.sh` напечатает путь к сертификату, как его указывать в панели
   
3. сменить пароль админа

### Cоздать Inbound в 3X-UI

Трафик ходит так:

    браузер -> VPS_DOMAIN:443 
        -> 3x-ui inbound:443
            -> nginx docker container:10443 

Входящее HTTPS-соединение попадает на 3X-UI, это он сидит на внешнем интерфейсе. Nginx слушает только на внутреннем `localhost:10443`. 3X-UI перенаправляет внешний порт 443 на внутренний nginx. SSL обеспечивает nginx, он также донор (destination) для *X-Ray XTLS Reality*.


Параметры Inbound в 3X-UI (остальные можно не пока трогать):

    Protocol: vless
    Port: 443
    Security - выбрать вкладку Reality
        Target: 127.0.0.1:10443
        SNI: VPS_DOMAIN
        Public Key/Private Key - нажмите кнопку "Get New Cert"

С таким Inbound будет работать сайт `https://VPS_DOMAIN` - сейчас на нем крутится FileBrowser, пароль от админа он напечатал при первом старте.

## Пароль к FileBrowser

Пишется в лог при первом старте. Посмотреть:

`./filebrowser-password.sh` по сути  `docker compose logs | grep password`

Чтобы сбросить - нужно удалить **все данные** filebrowser и он создаст новый пароль и напишет в лог. Следующая команда сделает это и выведет пароль:

`./filebrowser-delete-data.sh`
    
    filebrowser-1  | User 'admin' initialized with randomly generated password: zbKQSdn9VJPM6kAV

### Переключение с тестового сертификата на настоящий

Если всё работает и сайт открывается с тестовым SSL, можно получить реальный сертификат:

1. Раскомментируйте production ACME_SERVER в файле `.env`
2. Запустите `./delete-certificate.sh`
3. Выведется лог получения сертификата


### Окончательная настройка VPN

Лучше заходить на панель по IP-адресу, а не по имени домена, чтобы QR и ключи для адреса создавались по IP-адресу, а не по доменному имени.

Донастроить Inbound
* Выключить встроенный Subscription service.
* Создать или отредактировать клиента и указать `flow: xtls-rprx-vision`. Это и есть **VLESS-Reality**.
* Нажать иконку QR-кода и импортировать подключение в vpn-клиент.

### Настройка подписки

Когда есть несколько серверов и они периодически переезжают и переконфигурятся, программы-клиенты умеют обновлять ключи из специального URL, который называется подписка (subscription).

Специальный `https://$YOURDOMAIN/$SUBSCRIPTION_URL` показывает содержимое файла `srv/nginx/www/subscription/ss.txt`. Меняя этот файл - обновляем всех клиентов. Подробности в srv/nginx/www/subscription/README.txt

Subscription - полезная фича.

## Обновление

Обновить всё: 

`./update.sh`

Обновить certbot, 3x-ui и nginx:

```
./down.sh
./update-images.sh
./up.sh
```

Обновить только код этого проекта:

```
./down.sh
./update-code-and-build.sh
./up.sh
```

## Реконфигурация с нуля

Удалите `srv` и `_work`, скопируйте `srv-default` в `srv` и повторите настройку. Следующий скрипт все сбросит как было (кроме  `.env` - его вы, скорее всего, хотите оставить):

`./reconfig-from-scratch.sh`

# Вроде всё
Настройка, собственно, VPN VLESS в панели 3X-UI с картинками будет позже. Впрочем, таких гайдов много. Данный проект призван:
- автоматизировать получение/обновление сертификатов для режима VLESS-Reality "сертификат берем у себя"
- обновлять geo-файлы, чтобы **трафик до России заворачивать назад**.
- поднять ненапряжный веб-файлообменник для обмена большими файлами (закачка по паролю). 
- поднять ненепряжное статическое хранилище файлов (закачка по ssh)

### Еще можно
Перевесить sshd c 22 порта на повыше, прикрутить бесплатную graphana и мониторить загрузку VPS. Отрубить UDP и ICMP. Порт панели 3X-UI закрыть через файрволл.

Пока пойдет и так, основное сделано.

## Домашний VPN в 2026г
- два сервера за границей (один может сломаться) 
- два в РФ (один может сломаться)
- заграничные сервера устанавливают xray-reverse туннель до российских
- SUBSCRIPTION_URL (https//mydomain.de/subs52050#MyHomeVPS), в котором прописаны оба русских сервера. клиенты будут автопереключаться и обновляться.

  файл подписки настраивается на одном сервере, его URL отдается клиентам.

- ОБЯЗАТЕЛЬНО изменить порт и путь (!) в панели 3X-UI. Панель должна открываться по пути вроде https://mydomain:52050/abc123. Изменения одного порта недостаточно - факт наличия панели обнаруживается очень быстро и сервер уходит в блок.

◼
